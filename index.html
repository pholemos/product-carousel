<!DOCTYPE html>
<html lang="en" class="bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Affiliate Carousel</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM UMD (Production) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for on-the-fly JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .carousel-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        #root {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10px;
        }

        img {
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const DATA_URL = 'https://raw.githubusercontent.com/pholemos/youtube-carousel/refs/heads/main/Affiliate_List.json';

        const REGION_MAPPING = {
            'GB': 'UK',
            'US': 'USA',
            'ES': 'Spain',
            'DE': 'Germany',
        };

        const FILTER_RULES = {
            'UK': ['UK', 'aliexpress'],
            'USA': ['USA', 'aliexpress'],
            'Spain': ['Spain', 'aliexpress'],
            'Germany': ['Germany', 'aliexpress'],
            'Global': [], 
        };

        // NEW: Real IP Geolocation Detection
        const detectActualRegion = async () => {
            try {
                // Try IP-based detection first (most accurate for iframe)
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                if (data.country_code) {
                    return REGION_MAPPING[data.country_code] || 'Global';
                }
            } catch (e) {
                console.warn('IP Geolocation failed, falling back to locale.');
            }
            
            // Fallback: Browser Locale
            try {
                const locale = Intl.DateTimeFormat().resolvedOptions().locale;
                const countryCode = locale.split('-')[1]?.toUpperCase();
                return REGION_MAPPING[countryCode] || 'Global';
            } catch (e) {
                return 'Global';
            }
        };

        const ProductCard = ({ product }) => {
            const isAmazon = product.shop.toLowerCase().includes('amazon');
            return (
                <a 
                    href={product.affiliateLink || '#'} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="flex-none w-[70vw] sm:w-64 md:w-72 bg-zinc-900 rounded-xl shadow-lg border border-zinc-800 overflow-hidden transition-all duration-300 hover:border-zinc-700 active:scale-[0.98] sm:hover:-translate-y-1 block touch-manipulation group select-none"
                >
                    <div className="aspect-[4/3] w-full overflow-hidden bg-white/5 flex items-center justify-center relative">
                        <img 
                            src={product.imgLink} 
                            alt={product.title} 
                            className="w-full h-full object-contain p-4 transition-transform duration-500 sm:group-hover:scale-110"
                            loading="lazy"
                        />
                        <div className="absolute inset-0 bg-black/5 group-hover:bg-transparent transition-colors duration-300"></div>
                        <div className="absolute top-2 left-2">
                             <span className="bg-black/60 backdrop-blur-md text-[8px] font-bold text-white px-2 py-0.5 rounded uppercase tracking-tighter">
                                {product.country}
                             </span>
                        </div>
                    </div>
                    
                    <div className="p-4 flex flex-col h-28 sm:h-32 justify-between">
                        <h3 className="text-xs sm:text-sm font-semibold text-zinc-100 line-clamp-2 leading-snug">
                            {product.title}
                        </h3>
                        <div className="mt-2 flex items-center justify-between">
                            <span className={`text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider ${
                                isAmazon 
                                    ? 'bg-amber-500/10 text-amber-500 border border-amber-500/20' 
                                    : 'bg-red-500/10 text-red-500 border border-red-500/20'
                            }`}>
                                {product.shop}
                            </span>
                            <span className="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">
                                Deal
                            </span>
                        </div>
                    </div>
                </a>
            );
        };

        const Carousel = ({ products }) => {
            const scrollRef = useRef(null);
            const [isPaused, setIsPaused] = useState(false);
            const [showLeftArrow, setShowLeftArrow] = useState(false);
            const [showRightArrow, setShowRightArrow] = useState(true);

            const handleScrollState = () => {
                if (scrollRef.current) {
                    const { scrollLeft, scrollWidth, clientWidth } = scrollRef.current;
                    setShowLeftArrow(scrollLeft > 20);
                    setShowRightArrow(scrollLeft < scrollWidth - clientWidth - 20);
                }
            };

            const scroll = (direction) => {
                if (scrollRef.current) {
                    const { scrollLeft, clientWidth, scrollWidth } = scrollRef.current;
                    let scrollTo;
                    if (direction === 'left') {
                        scrollTo = scrollLeft - clientWidth * 0.8;
                        if (scrollTo < 0) scrollTo = scrollWidth - clientWidth;
                    } else {
                        scrollTo = scrollLeft + clientWidth * 0.8;
                        if (scrollTo + clientWidth >= scrollWidth - 10) scrollTo = 0;
                    }
                    scrollRef.current.scrollTo({ left: scrollTo, behavior: 'smooth' });
                }
            };

            useEffect(() => {
                if (isPaused || products.length <= 1) return;
                const interval = setInterval(() => scroll('right'), 5000);
                return () => clearInterval(interval);
            }, [isPaused, products.length]);

            if (products.length === 0) return null;

            return (
                <div 
                    className="relative w-full overflow-hidden"
                    onMouseEnter={() => setIsPaused(true)}
                    onMouseLeave={() => setIsPaused(false)}
                    onTouchStart={() => setIsPaused(true)}
                    onTouchEnd={() => setIsPaused(false)}
                >
                    <div className="relative group px-4">
                        <div className={`absolute left-6 top-1/2 -translate-y-1/2 z-10 transition-all duration-300 hidden lg:block ${showLeftArrow ? 'opacity-0 group-hover:opacity-100' : 'opacity-0 pointer-events-none'}`}>
                            <button onClick={() => scroll('left')} className="p-3 rounded-full border border-zinc-700 bg-zinc-900/90 backdrop-blur-xl text-zinc-100 shadow-2xl hover:bg-zinc-800 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <div className={`absolute right-6 top-1/2 -translate-y-1/2 z-10 transition-all duration-300 hidden lg:block ${showRightArrow ? 'opacity-0 group-hover:opacity-100' : 'opacity-0 pointer-events-none'}`}>
                            <button onClick={() => scroll('right')} className="p-3 rounded-full border border-zinc-700 bg-zinc-900/90 backdrop-blur-xl text-zinc-100 shadow-2xl hover:bg-zinc-800 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <div 
                            ref={scrollRef}
                            onScroll={handleScrollState}
                            className="flex space-x-4 overflow-x-auto py-4 scrollbar-hide snap-x carousel-container"
                            style={{ scrollSnapType: 'x mandatory' }}
                        >
                            {products.map((p, i) => (
                                <div key={`${p.title}-${i}`} className="snap-center">
                                    <ProductCard product={p} />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const initData = async () => {
                    try {
                        setLoading(true);
                        
                        // Perform Geo-check and Data-fetch in parallel
                        const [geoRegion, dataRes] = await Promise.all([
                            detectActualRegion(),
                            fetch(DATA_URL)
                        ]);

                        if (!dataRes.ok) throw new Error('Data fetch failed');
                        const raw = await dataRes.json();
                        
                        const allowedTags = FILTER_RULES[geoRegion];
                        
                        let filtered = (geoRegion === 'Global' || !allowedTags || allowedTags.length === 0) 
                            ? raw 
                            : raw.filter(p => allowedTags.includes(p.country) || p.shop.toLowerCase().includes('aliexpress'));

                        if (filtered.length === 0) filtered = raw;

                        setProducts(filtered);
                        setError(null);
                    } catch (err) {
                        setError('Unable to load items.');
                    } finally {
                        setLoading(false);
                    }
                };
                initData();
            }, []);

            if (loading) return (
                <div className="w-full flex items-center justify-center h-48">
                    <div className="w-6 h-6 border-2 border-zinc-800 border-t-indigo-500 rounded-full animate-spin"></div>
                </div>
            );

            if (error) return (
                <div className="w-full text-center text-zinc-600 text-[10px] uppercase font-bold tracking-widest py-10">
                    Connection Error
                </div>
            );

            return (
                <div className="w-full max-w-screen-xl mx-auto">
                    <Carousel products={products} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>